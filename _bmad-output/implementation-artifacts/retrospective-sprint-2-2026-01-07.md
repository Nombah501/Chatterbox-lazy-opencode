# Retrospective — Sprint 2

Дата: 2026-01-07

## Выполненные истории (7 историй, 24 SP)

**Epic 1 — Прозрачный синтез результатов**
- Story 1.2 — Прозрачные цитаты-источники (5 SP, High) ✅

**Epic 2 — Озвучка и управление TTS**
- Story 2.1 — Включение и выключение TTS (3 SP, High) ✅
- Story 2.5 — Интеграция chatterbox TTS (5 SP, High) ✅
- Story 2.4 — Авто-отключение в CI/неинтерактиве (2 SP, High) ✅
- Story 2.2 — Выбор голоса и скорости (3 SP, Medium) ✅

**Epic 3 — Сохранение и обмен результатами**
- Story 1.3 — Управление уровнем детализации вывода (3 SP, Medium) ✅
- Story 3.1 — Экспорт результата в файл (3 SP, Medium) ✅

## Что пошло хорошо

1. Stable TTS integration — ChatterboxProvider с кэшированием моделей работает стабильно.
2. Неблокирующий TTS — daemon thread не блокирует CLI.
3. Авто-детект CI — `_is_ci_or_noninteractive()` корректно определяет CI/неинтерактивную среду.
4. Управление детализацией — флаги `--show-summary/--no-summary`, `--show-divergences/--no-divergences`, `--show-citations/--no-citations`, `--verbose` работают.
5. Экспорт в файл — `--output` с форматом txt/md реализован.
6. Привязка цитат к agent_id — `_extract_citations()` группирует цитаты по агентам.
7. Конфигурация TTS — все параметры доступны через CLI/конфиг.

## С чем столкнулись

1. Параметры voice/speed/tags могут не поддерживаться chatterbox API.
2. HF_TOKEN через прямое присваивание перезаписывает существующее значение.
3. Пустые цитаты создают записи "Цитата отсутствуют".
4. Нет логирования при использовании дефолтов вместо пользовательских значений.
5. Детект CI базируется только на env vars и isatty().
6. Нет предупреждения при перезаписи файлов при экспорте.

## Технический долг

| Пункт | История | Приоритет |
|--------|-----------|-----------|
| voice/speed/tags не валидируются | Story 2.5 | Medium |
| HF_TOKEN прямое присваивание | Story 2.5 | Medium |
| Пустые цитаты не пропускаются | Story 1.2 | Low |
| Нет логирования дефолтов | Story 2.2 | Low |
| Детект CI неполный | Story 2.4 | Low |
| Перезапись файлов без предупреждения | Story 3.1 | Low |

## Рекомендации

1. Закрыть Stories 1.1 и 2.3 как done (уже выполнены).
2. Провести source-code review chatterbox API для параметров.
3. Исправить HF_TOKEN на setdefault.
4. Добавить валидацию параметров TTS.
5. Пропускать пустые цитаты.
6. Добавить тесты для TTS и экспорта.
7. Улучшить детект CI.
8. Добавить предупреждение при перезаписи файлов.

## Подготовка к следующим эпикам

**Epic 1:** Story 1.4 (Статусы обработки) — ready-for-dev
**Epic 2:** Все истории выполнены
**Epic 3:** Story 3.2 (Экспорт с выбранными секциями) — готова к планированию
